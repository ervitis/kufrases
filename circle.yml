machine:
  php:
    version: 7.0.17

deployment:
  production:
    pre:
      - pyenv global 2.7.12
  staging:
    commands:
      - gcloud app deploy app.yaml
      - python e2e_ping.py

dependencies:
  pre:
    # Install packages
    - export CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)"
    - echo "deb http://packages.cloud.google.com/apt ${CLOUD_SDK_REPO} main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
    - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
    - sudo apt-get update
    - sudo apt-get install google-cloud-sdk google-cloud-sdk-app-engine-python google-cloud-sdk-datastore-emulator php-bcmath php-mbstring
    - curl -o ${HOME}/google_appengine_1.9.40.zip https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.40.zip
    - unzip -q -d ${HOME} ${HOME}/google_appengine_1.9.40.zip
    - composer install

    # Setup the appengine environment
    - echo ${CLIENT_SECRET} | base64 --decode > ${HOME}/client-secret.json
    - gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
    - gcloud config set ${HOST_APPENGINE}

test:
  post:
    - git reset --hard
    - git clean -d -x -f